<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finan√ßas MAD (Cloud)</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    
    <style>
        /* (Mantendo o mesmo estilo bonito e responsivo do anterior) */
        :root { --primary: #2c3e50; --accent: #27ae60; --danger: #c0392b; --bg: #f4f7f6; --card: #ffffff; --text: #333; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 80px; }
        header { background: var(--primary); color: white; padding: 1rem; text-align: center; position: sticky; top: 0; z-index: 100; }
        .container { padding: 15px; max-width: 600px; margin: 0 auto; }
        .card { background: var(--card); border-radius: 10px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .summary-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .stat-box { text-align: center; padding: 10px; background: #f8f9fa; border-radius: 8px; }
        .stat-value { font-weight: bold; font-size: 1.1rem; }
        .green { color: var(--accent); } .red { color: var(--danger); }
        input, select, button { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        button { background: var(--primary); color: white; border: none; cursor: pointer; }
        .hidden { display: none; }
        .transaction-item { display: flex; justify-content: space-between; border-bottom: 1px solid #eee; padding: 10px 0; }
        nav { position: fixed; bottom: 0; width: 100%; background: white; display: flex; justify-content: space-around; padding: 10px 0; border-top: 1px solid #eee; }
        nav button { background: none; color: #777; width: auto; margin: 0; }
        nav button.active { color: var(--primary); font-weight: bold; }
        .budget-bar { height: 8px; background: #eee; border-radius: 4px; margin-top: 5px; }
        .budget-fill { height: 100%; background: var(--accent); }
    </style>
</head>
<body>

<header>
    <h3>Finan√ßas Cloud (MAD)</h3>
    <input type="month" id="monthFilter" style="width: auto; padding: 5px; color: black; margin:0;">
</header>

<div id="loading" style="text-align: center; padding: 20px;">Carregando dados da nuvem...</div>

<div id="view-dashboard" class="container hidden">
    <div class="card">
        <div class="summary-grid">
            <div class="stat-box">Entradas<div class="stat-value green" id="totalIncome">0</div></div>
            <div class="stat-box">Sa√≠das<div class="stat-value red" id="totalExpense">0</div></div>
        </div>
        <div style="text-align: center; margin-top: 10px;">
            Saldo: <span id="finalBalance" style="font-weight:bold; font-size:1.2rem;">0</span>
        </div>
    </div>
    <div class="card">
        <h4>Or√ßamentos (Mensal)</h4>
        <div id="budgetList"></div>
    </div>
    <div class="card">
        <h4>Hist√≥rico</h4>
        <div id="recentTransactionsList"></div>
    </div>
</div>

<div id="view-add" class="container hidden">
    <div class="card">
        <h4>Novo Lan√ßamento</h4>
        <select id="inputType"><option value="expense">Despesa</option><option value="income">Receita</option></select>
        <input type="text" id="inputItem" placeholder="Item (Ex: Caf√©)">
        <select id="inputCategory"><option>Carregando...</option></select>
        <div class="summary-grid">
            <input type="number" id="inputQty" value="1" placeholder="Qtd">
            <input type="number" id="inputPrice" placeholder="Pre√ßo (MAD)">
        </div>
        <input type="date" id="inputDate">
        <button onclick="saveTransaction()">Salvar na Nuvem</button>
    </div>
</div>

<div id="view-settings" class="container hidden">
    <div class="card">
        <h4>Criar Categoria</h4>
        <input type="text" id="newCatName" placeholder="Nome">
        <input type="number" id="newCatBudget" placeholder="Meta Mensal">
        <button onclick="saveCategory()">Adicionar Categoria</button>
        <div id="settingsCategoryList" style="margin-top:15px;"></div>
    </div>
</div>

<nav>
    <button onclick="switchView('dashboard')" id="nav-dashboard" class="active">üìä Resumo</button>
    <button onclick="switchView('add')" id="nav-add">‚ûï Novo</button>
    <button onclick="switchView('settings')" id="nav-settings">‚öôÔ∏è Config</button>
</nav>

<script>
    // --- 1. CONFIGURA√á√ÉO DO FIREBASE ---
    const firebaseConfig = {

  apiKey: "AIzaSyATkpiODXMz-TaHhqq7pVs9qmMktbcBPcE",
  authDomain: "financas-abel.firebaseapp.com",
  projectId: "financas-abel",
  storageBucket: "financas-abel.firebasestorage.app",
  messagingSenderId: "760243071362",
  appId: "1:760243071362:web:d58bc675d1ac3cd56d079b"
    };

    // Inicializa Firebase
    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.firestore();

    // --- ESTADO LOCAL ---
    let localCategories = [];
    let localTransactions = [];

    // --- INICIALIZA√á√ÉO ---
    function init() {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('inputDate').value = today;
        document.getElementById('monthFilter').value = today.slice(0, 7);
        document.getElementById('monthFilter').addEventListener('change', renderDashboard);

        // OUVINTES EM TEMPO REAL (REAL-TIME LISTENERS)
        // Isso faz a m√°gica: se atualizar no PC, atualiza no celular na hora.
        
        // 1. Escutar Categorias
        db.collection('categories').onSnapshot(snapshot => {
            localCategories = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
            renderCategorySelect();
            renderSettingsList();
            renderDashboard();
            document.getElementById('loading').style.display = 'none';
            document.getElementById('view-dashboard').classList.remove('hidden');
        });

        // 2. Escutar Transa√ß√µes
        db.collection('transactions').onSnapshot(snapshot => {
            localTransactions = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
            renderDashboard();
        });
    }

    // --- FUN√á√ïES DE SALVAR (AGORA NA NUVEM) ---
    function saveTransaction() {
        const type = document.getElementById('inputType').value;
        const item = document.getElementById('inputItem').value;
        const catId = document.getElementById('inputCategory').value;
        const date = document.getElementById('inputDate').value;
        const qty = parseFloat(document.getElementById('inputQty').value) || 1;
        const price = parseFloat(document.getElementById('inputPrice').value) || 0;

        if (!item || !price) return alert("Preencha item e pre√ßo");

        // Grava no Firestore
        db.collection('transactions').add({
            type, item, categoryId: catId, date, qty, unitPrice: price, 
            total: qty * price, createdAt: new Date()
        }).then(() => {
            alert("Salvo!");
            document.getElementById('inputItem').value = '';
            document.getElementById('inputPrice').value = '';
            switchView('dashboard');
        }).catch(err => alert("Erro: " + err));
    }

    function saveCategory() {
        const name = document.getElementById('newCatName').value;
        const budget = parseFloat(document.getElementById('newCatBudget').value);
        
        if(!name) return;

        db.collection('categories').add({
            name, budget
        });
        document.getElementById('newCatName').value = '';
    }

    function deleteCategory(id) {
        if(confirm("Apagar categoria?")) db.collection('categories').doc(id).delete();
    }

    // --- RENDERIZA√á√ÉO (VISUAL) ---
    function renderDashboard() {
        const currentMonth = document.getElementById('monthFilter').value;
        const monthTx = localTransactions.filter(t => t.date.startsWith(currentMonth));
        
        let inc = 0, exp = 0;
        const catSpend = {};
        
        monthTx.forEach(t => {
            if(t.type === 'income') inc += t.total;
            else {
                exp += t.total;
                catSpend[t.categoryId] = (catSpend[t.categoryId] || 0) + t.total;
            }
        });

        document.getElementById('totalIncome').innerText = formatMoney(inc);
        document.getElementById('totalExpense').innerText = formatMoney(exp);
        document.getElementById('finalBalance').innerText = formatMoney(inc - exp);

        // Or√ßamentos
        const budgDiv = document.getElementById('budgetList');
        budgDiv.innerHTML = '';
        localCategories.forEach(cat => {
            const spent = catSpend[cat.id] || 0;
            const pct = Math.min((spent / cat.budget)*100, 100);
            budgDiv.innerHTML += `
                <div style="margin-bottom:10px; font-size:0.9rem">
                    <div style="display:flex; justify-content:space-between">
                        <span>${cat.name}</span>
                        <span>${spent}/${cat.budget}</span>
                    </div>
                    <div class="budget-bar"><div class="budget-fill" style="width:${pct}%; background:${spent>cat.budget?'red':'#27ae60'}"></div></div>
                </div>`;
        });

        // Lista
        const listDiv = document.getElementById('recentTransactionsList');
        listDiv.innerHTML = '';
        monthTx.sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(t => {
            listDiv.innerHTML += `
                <div class="transaction-item">
                    <div><b>${t.item}</b> <small>(${t.date})</small></div>
                    <div style="color:${t.type==='expense'?'red':'green'}">${t.type==='expense'?'-':'+'} ${t.total}</div>
                </div>`;
        });
    }

    function renderCategorySelect() {
        const sel = document.getElementById('inputCategory');
        sel.innerHTML = '';
        localCategories.forEach(c => {
            const opt = document.createElement('option');
            opt.value = c.id;
            opt.innerText = c.name;
            sel.appendChild(opt);
        });
    }
    
    function renderSettingsList() {
        const div = document.getElementById('settingsCategoryList');
        div.innerHTML = '';
        localCategories.forEach(c => {
            div.innerHTML += `<div class="transaction-item">${c.name} <button onclick="deleteCategory('${c.id}')" style="width:auto;padding:5px;background:#c0392b">X</button></div>`;
        });
    }

    function switchView(v) {
        ['dashboard','add','settings'].forEach(x => {
            document.getElementById('view-'+x).classList.add('hidden');
            document.getElementById('nav-'+x).classList.remove('active');
        });
        document.getElementById('view-'+v).classList.remove('hidden');
        document.getElementById('nav-'+v).classList.add('active');
    }

    function formatMoney(v) { return v.toLocaleString('fr-MA', {style:'currency', currency:'MAD'}); }

    init();
</script>
</body>
</html>